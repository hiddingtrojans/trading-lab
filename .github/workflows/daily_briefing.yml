name: Daily Market Briefing

on:
  schedule:
    - cron: '30 13 * * 1-5'  # 8:30 AM ET
  workflow_dispatch:

jobs:
  briefing:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - run: pip install -r requirements.txt
      
      - name: Generate Briefing
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python -c "
          import os, sys, urllib.request, urllib.parse
          from datetime import datetime
          sys.path.insert(0, 'src')

          token = os.environ['TELEGRAM_BOT_TOKEN']
          chat_id = os.environ['TELEGRAM_CHAT_ID']

          def send(msg):
              url = f'https://api.telegram.org/bot{token}/sendMessage'
              data = urllib.parse.urlencode({'chat_id': chat_id, 'text': msg}).encode()
              urllib.request.urlopen(urllib.request.Request(url, data=data), timeout=10)

          import yfinance as yf
          from alpha_lab.market_regime import MarketRegimeAnalyzer
          from alpha_lab.sector_rotation import SectorRotationAnalyzer
          from utils.data_fetcher import DataFetcher

          fetcher = DataFetcher(None)

          # SECTOR NAMES
          sector_names = {
              'XLK': 'Technology', 'XLC': 'Communications', 'XLY': 'Consumer Discretionary',
              'XLF': 'Financials', 'XLE': 'Energy', 'XLV': 'Healthcare',
              'XLI': 'Industrials', 'XLB': 'Materials', 'XLU': 'Utilities',
              'XLRE': 'Real Estate', 'XLP': 'Consumer Staples'
          }

          # SCAN UNIVERSE (liquid stocks across sectors)
          universe = [
              ('NVDA', 'NVIDIA'), ('AAPL', 'Apple'), ('MSFT', 'Microsoft'), ('GOOGL', 'Alphabet'),
              ('META', 'Meta'), ('AMZN', 'Amazon'), ('TSLA', 'Tesla'), ('AMD', 'AMD'),
              ('JPM', 'JPMorgan'), ('GS', 'Goldman Sachs'), ('V', 'Visa'),
              ('XOM', 'Exxon'), ('CVX', 'Chevron'),
              ('UNH', 'UnitedHealth'), ('JNJ', 'Johnson & Johnson'),
              ('CAT', 'Caterpillar'), ('BA', 'Boeing'),
              ('NFLX', 'Netflix'), ('DIS', 'Disney'),
              ('COIN', 'Coinbase'), ('SQ', 'Block'), ('PLTR', 'Palantir'),
          ]

          # 1. REGIME
          regime = MarketRegimeAnalyzer(fetcher).analyze_regime()
          regime_emoji = {'GREEN': 'ðŸŸ¢', 'YELLOW': 'ðŸŸ¡', 'RED': 'ðŸ”´'}.get(regime['status'], 'âšª')

          # 2. SPY KEY LEVELS
          spy = yf.Ticker('SPY').history(period='1mo')
          spy_price = spy['Close'].iloc[-1]
          spy_sma20 = spy['Close'].rolling(20).mean().iloc[-1]
          spy_change = (spy['Close'].iloc[-1] / spy['Close'].iloc[-2] - 1) * 100

          # 3. SECTORS
          sectors = SectorRotationAnalyzer(fetcher).analyze_sectors()
          rankings = sectors.get('rankings', [])
          
          leading_sectors = []
          for s in rankings[:3]:
              if s.get('score', 0) > 70:
                  name = sector_names.get(s['ticker'], s['ticker'])
                  leading_sectors.append(f\"{name} ({s['ticker']})\")

          # 4. SCAN STOCKS - find momentum + strength
          opportunities = []
          for ticker, name in universe:
              try:
                  hist = yf.Ticker(ticker).history(period='1mo')
                  if len(hist) < 20:
                      continue
                  
                  price = hist['Close'].iloc[-1]
                  sma20 = hist['Close'].rolling(20).mean().iloc[-1]
                  mom_5d = (hist['Close'].iloc[-1] / hist['Close'].iloc[-5] - 1) * 100
                  mom_20d = (hist['Close'].iloc[-1] / hist['Close'].iloc[0] - 1) * 100
                  above_sma = price > sma20
                  
                  # Score: momentum + trend
                  score = 0
                  if mom_5d > 3: score += 2
                  elif mom_5d > 0: score += 1
                  if mom_20d > 10: score += 2
                  elif mom_20d > 5: score += 1
                  if above_sma: score += 2
                  
                  if score >= 3:  # Only interesting ones
                      opportunities.append({
                          'ticker': ticker,
                          'name': name,
                          'price': price,
                          'mom_5d': mom_5d,
                          'mom_20d': mom_20d,
                          'above_sma': above_sma,
                          'score': score
                      })
              except Exception as e:
                  continue

          # Sort by score
          opportunities.sort(key=lambda x: x['score'], reverse=True)
          top_5 = opportunities[:5]

          # BUILD MESSAGE
          msg = f'''{regime_emoji} MORNING BRIEFING - {datetime.now().strftime('%b %d, %Y')}

          MARKET REGIME: {regime['status']}
          {regime['action']}

          SPY: \${spy_price:.2f} ({spy_change:+.1f}%)
          Key Support: \${spy_sma20:.2f}

          '''
          
          if leading_sectors:
              msg += f\"\"\"STRONG SECTORS:
          {chr(10).join(['â€¢ ' + s for s in leading_sectors])}

          \"\"\"

          if top_5:
              msg += 'TOP OPPORTUNITIES:\\n'
              for opp in top_5:
                  trend = 'â†‘' if opp['above_sma'] else 'â†“'
                  msg += f\"\"\"
          {opp['name']} ({opp['ticker']}) {trend}
          \${opp['price']:.2f} | 5d: {opp['mom_5d']:+.1f}% | 20d: {opp['mom_20d']:+.1f}%
          \"\"\"
          else:
              msg += 'No strong setups today. Cash is a position.'

          msg += '''

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Full analysis: python launcher.py'''

          send(msg)
          print('Briefing sent!')
          "
