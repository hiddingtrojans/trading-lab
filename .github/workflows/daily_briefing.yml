name: Daily Market Briefing

on:
  schedule:
    - cron: '30 13 * * 1-5'  # 8:30 AM ET
  workflow_dispatch:

jobs:
  briefing:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - run: pip install -r requirements.txt
      
      - name: Scan Universe and Send Alert
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python -c "
          import os, sys, urllib.request, urllib.parse
          from datetime import datetime
          sys.path.insert(0, 'src')

          token = os.environ['TELEGRAM_BOT_TOKEN']
          chat_id = os.environ['TELEGRAM_CHAT_ID']

          def send(msg):
              url = f'https://api.telegram.org/bot{token}/sendMessage'
              data = urllib.parse.urlencode({'chat_id': chat_id, 'text': msg}).encode()
              urllib.request.urlopen(urllib.request.Request(url, data=data), timeout=30)

          import yfinance as yf
          from alpha_lab.market_regime import MarketRegimeAnalyzer
          from alpha_lab.universe_scanner import UniverseScanner
          from utils.data_fetcher import DataFetcher

          print('Starting scan...')

          # 1. MARKET REGIME
          fetcher = DataFetcher(None)
          regime = MarketRegimeAnalyzer(fetcher).analyze_regime()
          regime_emoji = {'GREEN': 'ðŸŸ¢', 'YELLOW': 'ðŸŸ¡', 'RED': 'ðŸ”´'}.get(regime['status'], 'âšª')

          # 2. SPY CONTEXT
          spy = yf.Ticker('SPY').history(period='1mo')
          spy_price = spy['Close'].iloc[-1]
          spy_sma20 = spy['Close'].rolling(20).mean().iloc[-1]
          spy_change = (spy['Close'].iloc[-1] / spy['Close'].iloc[-2] - 1) * 100

          # 3. SCAN UNIVERSE (this is the real work)
          print('Scanning 150+ small/mid caps...')
          scanner = UniverseScanner(include_mid_caps=True)
          results = scanner.scan(top_n=5)

          # 4. BUILD MESSAGE
          msg = f'''{regime_emoji} MORNING SCAN - {datetime.now().strftime('%b %d')}

          REGIME: {regime['status']} ({regime['score']}/100)
          {regime['action']}

          SPY: \${spy_price:.2f} ({spy_change:+.1f}%)
          Support: \${spy_sma20:.2f}

          '''

          if results:
              msg += 'TOP OPPORTUNITIES:\\n'
              msg += '(sorted by Edge Score)\\n'
              msg += '-' * 30 + '\\n'
              
              for r in results:
                  # Format market cap
                  if r['market_cap_b'] >= 1:
                      mcap = f\"\${r['market_cap_b']:.1f}B\"
                  else:
                      mcap = f\"\${r['market_cap_b']*1000:.0f}M\"
                  
                  msg += f'''
          {r['name']} ({r['ticker']})
          \${r['price']:.2f} | {mcap} | Score: {r['edge_score']}
          5D: {r['mom_5d']:+.1f}% | Vol: {r['volume_change']:+.0f}%
          Setup: {r['setup_type']}
          Why: {r['why']}
          Entry: \${r['support']:.2f} | Target: \${r['resistance']:.2f}
          '''
          else:
              msg += 'No setups meeting criteria today.\\nCash is a position.'

          msg += '''
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Full scan: python launcher.py â†’ Option 8'''

          send(msg)
          print('Alert sent!')
          "
