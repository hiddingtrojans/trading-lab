name: Trade Signals

on:
  schedule:
    - cron: '30 13 * * 1-5'  # 8:30 AM ET
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - run: pip install yfinance pandas numpy
      
      - name: Scan and Send Signals
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python -c "
          import os, sys, urllib.request, urllib.parse
          from datetime import datetime
          sys.path.insert(0, 'src')

          token = os.environ['TELEGRAM_BOT_TOKEN']
          chat_id = os.environ['TELEGRAM_CHAT_ID']

          def send(msg):
              url = f'https://api.telegram.org/bot{token}/sendMessage'
              data = urllib.parse.urlencode({'chat_id': chat_id, 'text': msg}).encode()
              urllib.request.urlopen(urllib.request.Request(url, data=data), timeout=30)

          import yfinance as yf
          from alpha_lab.trade_scanner import TradeScanner, format_trade_signals
          from alpha_lab.market_regime import MarketRegimeAnalyzer
          from utils.data_fetcher import DataFetcher

          # 1. REGIME CHECK
          fetcher = DataFetcher(None)
          regime = MarketRegimeAnalyzer(fetcher).analyze_regime()
          
          emoji = {'GREEN': 'ðŸŸ¢', 'YELLOW': 'ðŸŸ¡', 'RED': 'ðŸ”´'}.get(regime['status'], 'âšª')
          
          # 2. SPY CONTEXT
          spy = yf.Ticker('SPY').history(period='5d')
          spy_price = spy['Close'].iloc[-1]
          spy_change = (spy['Close'].iloc[-1] / spy['Close'].iloc[-2] - 1) * 100

          # 3. TRADE SIGNALS
          scanner = TradeScanner(risk_per_trade=500)
          signals = scanner.scan(top_n=5)

          # 4. BUILD MESSAGE
          msg = f'''{emoji} {regime['status']} | SPY \${spy_price:.2f} ({spy_change:+.1f}%)
          {regime['action']}
          '''
          
          if regime['status'] == 'RED':
              msg += '''
          No new longs. Reduce exposure.
          '''
          elif signals:
              msg += '''
          TRADE SETUPS:
          '''
              for s in signals:
                  warning = f\"  {s['earnings_warning']}\" if s['earnings_warning'] else ''
                  msg += f'''
          {s['action']}: {s['name']} ({s['ticker']})
          Now: \${s['price']} | 5D: {s['mom_5d']:+.1f}%
          Entry: \${s['entry']} | Stop: \${s['stop']} | Target: \${s['target']}
          R:R 1:{s['rr_ratio']} | {s['shares']} shares (\${s['risk_amount']:.0f} risk)
          {s['reason']}{warning}
          '''
          else:
              msg += '''
          No clean setups. Wait for better entries.
          '''

          send(msg)
          print('Signals sent!')
          "
