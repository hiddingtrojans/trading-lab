name: Daily Market Briefing

on:
  schedule:
    - cron: '30 13 * * 1-5'  # 8:30 AM ET (EDT)
  workflow_dispatch:

jobs:
  briefing:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Run Market Analysis & Send Alert
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python -c "
          import os
          import sys
          import urllib.request
          import urllib.parse
          from datetime import datetime

          sys.path.insert(0, 'src')

          token = os.environ['TELEGRAM_BOT_TOKEN']
          chat_id = os.environ['TELEGRAM_CHAT_ID']

          def send_telegram(msg):
              url = f'https://api.telegram.org/bot{token}/sendMessage'
              data = urllib.parse.urlencode({'chat_id': chat_id, 'text': msg}).encode()
              req = urllib.request.Request(url, data=data)
              urllib.request.urlopen(req, timeout=10)

          # 1. Market Regime
          from alpha_lab.market_regime import MarketRegimeAnalyzer
          from utils.data_fetcher import DataFetcher

          fetcher = DataFetcher(None)
          regime_analyzer = MarketRegimeAnalyzer(fetcher)
          regime = regime_analyzer.analyze_regime()

          # 2. Sector Rotation
          from alpha_lab.sector_rotation import SectorRotationAnalyzer
          sector_analyzer = SectorRotationAnalyzer(fetcher)
          sectors = sector_analyzer.analyze_sectors()

          leading = [s['ticker'] for s in sectors.get('rankings', [])[:3] if s.get('status') == 'LEADING']
          lagging = [s['ticker'] for s in sectors.get('rankings', [])[-3:] if s.get('status') == 'LAGGING']

          # 3. Build Message
          msg = f'''Daily Market Briefing
          {datetime.now().strftime('%Y-%m-%d %H:%M')} UTC

          MARKET REGIME: {regime['status']}
          Score: {regime['score']}/100
          Action: {regime['action']}

          SECTORS:
          Leading: {', '.join(leading) if leading else 'None'}
          Lagging: {', '.join(lagging) if lagging else 'None'}

          Run 'python launcher.py' locally for full analysis.
          '''

          send_telegram(msg)
          print('Daily briefing sent to Telegram!')
          "
