name: Daily Trade Signals

on:
  schedule:
    - cron: '30 13 * * 1-5'  # 8:30 AM ET
  workflow_dispatch:

jobs:
  signals:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - run: pip install yfinance pandas numpy pyyaml scipy
      
      - name: Generate and Send Signals
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'src')
          
          import yfinance as yf
          from alpha_lab.trade_scanner import TradeScanner
          from alpha_lab.telegram_alerts import TelegramAlerter
          
          print('Getting market regime...')
          
          # Get regime
          spy = yf.Ticker('SPY')
          hist = spy.history(period='3mo')
          spy_price = hist['Close'].iloc[-1]
          spy_sma50 = hist['Close'].rolling(50).mean().iloc[-1]
          spy_change = (hist['Close'].iloc[-1] / hist['Close'].iloc[-2] - 1) * 100
          
          vix = yf.Ticker('^VIX')
          vix_hist = vix.history(period='5d')
          vix_level = vix_hist['Close'].iloc[-1] if len(vix_hist) > 0 else 20
          
          if spy_price > spy_sma50 and vix_level < 20:
              regime = {'status': 'GREEN', 'action': 'Aggressive longs', 'spy_price': spy_price}
          elif spy_price > spy_sma50 and vix_level < 30:
              regime = {'status': 'YELLOW', 'action': 'Selective, smaller size', 'spy_price': spy_price}
          else:
              regime = {'status': 'RED', 'action': 'No new longs', 'spy_price': spy_price}
          
          print(f'Regime: {regime[\"status\"]}')
          
          # Get signals (skip if RED)
          signals = []
          if regime['status'] != 'RED':
              print('Scanning for signals...')
              scanner = TradeScanner(risk_per_trade=500)
              signals = scanner.scan(top_n=5, check_breadth=False)  # Breadth check needs IBKR
              print(f'Found {len(signals)} signals')
          
          # Send via unified alerter
          alerter = TelegramAlerter()
          alerter.send_signal_alert(signals, regime)
          
          print('Signals sent!')
          "
