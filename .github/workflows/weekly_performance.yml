name: Weekly Performance Check

on:
  schedule:
    - cron: '0 14 * * 5'  # Every Friday 9 AM ET
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - run: pip install yfinance pandas numpy
      
      - name: Check Signal Performance
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python -c "
          import os, sys, urllib.request, urllib.parse
          sys.path.insert(0, 'src')
          
          token = os.environ['TELEGRAM_BOT_TOKEN']
          chat_id = os.environ['TELEGRAM_CHAT_ID']
          
          def send(msg):
              url = f'https://api.telegram.org/bot{token}/sendMessage'
              data = urllib.parse.urlencode({'chat_id': chat_id, 'text': msg}).encode()
              urllib.request.urlopen(urllib.request.Request(url, data=data), timeout=30)
          
          from alpha_lab.performance_checker import PerformanceChecker, format_for_telegram
          
          print('Running performance validation...')
          checker = PerformanceChecker()
          
          # Check 5-day old signals
          results = checker.backtest_signals(days_back=5, hold_days=5)
          
          msg = 'WEEKLY SIGNAL VALIDATION\n'
          msg += '=' * 30 + '\n'
          
          total = len(results['signals'])
          if total > 0:
              msg += f\"Win Rate: {results['win_rate']}%\n\"
              msg += f\"Record: {results['wins']}W / {results['losses']}L / {results['expired']}E\n\"
              msg += f\"Avg P&L: {results['avg_pnl']:+.2f}%\n\n\"
              
              msg += 'Recent Signals:\n'
              for s in results['signals'][:8]:
                  emoji = '+' if s['result'] == 'WIN' else ('-' if s['result'] == 'LOSS' else '~')
                  msg += f\"{emoji} {s['ticker']}: {s['pnl_pct']:+.1f}%\n\"
          else:
              msg += 'No signals found to validate.'
          
          send(msg)
          print('Performance report sent!')
          print(msg)
          "

