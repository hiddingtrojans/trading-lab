name: Regime Monitor

on:
  schedule:
    # Check regime at key times
    - cron: '0 14 * * 1-5'   # 9:00 AM ET (pre-market)
    - cron: '0 16 * * 1-5'   # 11:00 AM ET (mid-morning)
    - cron: '0 19 * * 1-5'   # 2:00 PM ET (afternoon)
  workflow_dispatch:

jobs:
  check_regime:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - run: pip install yfinance pandas numpy pyyaml
      
      - name: Check Regime
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python -c "
          import os
          import sys
          import json
          sys.path.insert(0, 'src')
          
          import yfinance as yf
          
          # Get current regime
          spy = yf.Ticker('SPY')
          hist = spy.history(period='3mo')
          spy_price = hist['Close'].iloc[-1]
          spy_sma50 = hist['Close'].rolling(50).mean().iloc[-1]
          
          vix = yf.Ticker('^VIX')
          vix_hist = vix.history(period='5d')
          vix_level = vix_hist['Close'].iloc[-1] if len(vix_hist) > 0 else 20
          
          # Determine current regime
          if spy_price > spy_sma50 and vix_level < 20:
              current = 'GREEN'
          elif spy_price > spy_sma50 and vix_level < 30:
              current = 'YELLOW'
          else:
              current = 'RED'
          
          # Load previous regime from cache
          cache_file = 'regime_cache.json'
          previous = None
          
          try:
              # Try to get from GitHub artifact or env
              previous = os.environ.get('PREVIOUS_REGIME', None)
          except:
              pass
          
          print(f'Current regime: {current}')
          print(f'SPY: \${spy_price:.2f} (SMA50: \${spy_sma50:.2f})')
          print(f'VIX: {vix_level:.1f}')
          
          # Only alert on change
          if previous and previous != current:
              from alpha_lab.telegram_alerts import send_regime
              send_regime(
                  old_regime=previous,
                  new_regime=current,
                  details={
                      'spy_price': spy_price,
                      'vix': vix_level,
                      'breadth': 50  # Would need real calculation
                  }
              )
              print(f'REGIME CHANGE: {previous} -> {current}')
          else:
              print('No regime change')
          
          # Save current regime
          print(f'::set-output name=regime::{current}')
          "

